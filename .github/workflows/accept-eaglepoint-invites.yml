name: Accept EaglepointAiLabs Invites

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  accept:
    runs-on: ubuntu-latest
    steps:
      - name: Accept matching repository invitations
        id: accept_invites
        env:
          INVITE_ACCEPT_TOKEN: ${{ secrets.INVITE_ACCEPT_TOKEN }}
          TARGET_ORG: eaglepointAiLabs
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${INVITE_ACCEPT_TOKEN:-}" ]]; then
            echo "INVITE_ACCEPT_TOKEN secret is missing."
            exit 1
          fi

          # Normalize accidental copy/paste whitespace/newlines in the secret value.
          token="$(printf '%s' "${INVITE_ACCEPT_TOKEN}" | tr -d '\r\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
          if [[ -z "${token}" ]]; then
            echo "INVITE_ACCEPT_TOKEN resolved to empty after trimming whitespace."
            exit 1
          fi

          api_base="https://api.github.com"
          auth_header="Authorization: Bearer ${token}"
          accept_header="Accept: application/vnd.github+json"
          api_version_header="X-GitHub-Api-Version: 2022-11-28"

          auth_status="$(curl -sS -o /tmp/gh_auth_check.json -w "%{http_code}" \
            -H "${accept_header}" \
            -H "${auth_header}" \
            -H "${api_version_header}" \
            "${api_base}/user")"

          if [[ "${auth_status}" != "200" ]]; then
            auth_message="$(jq -r '.message // "Unknown error"' /tmp/gh_auth_check.json 2>/dev/null || echo "Unknown error")"
            echo "GitHub token auth check failed with HTTP ${auth_status}: ${auth_message}"
            echo "Most common causes: invalid/revoked token, wrong secret value, or pasted extra characters."
            exit 1
          fi

          invitations_status="$(curl -sS -o /tmp/gh_invitations.json -w "%{http_code}" \
            -H "${accept_header}" \
            -H "${auth_header}" \
            -H "${api_version_header}" \
            "${api_base}/user/repository_invitations?per_page=100")"

          if [[ "${invitations_status}" != "200" ]]; then
            invitations_message="$(jq -r '.message // "Unknown error"' /tmp/gh_invitations.json 2>/dev/null || echo "Unknown error")"
            echo "Failed to fetch invitations (HTTP ${invitations_status}): ${invitations_message}"
            exit 1
          fi

          invitations_json="$(cat /tmp/gh_invitations.json)"

          total_invitations="$(jq 'length' <<< "${invitations_json}")"
          echo "Found ${total_invitations} pending invitation(s)."

          matching_json="$(jq -c --arg target "${TARGET_ORG}" \
            '[.[] | select(.inviter.login == $target or .repository.owner.login == $target)]' \
            <<< "${invitations_json}")"
          matching_invitations="$(jq 'length' <<< "${matching_json}")"
          echo "Matching invitation(s): ${matching_invitations}."

          accepted_invitations=0
          failed_invitations=0
          accepted_lines=()
          failed_lines=()

          while IFS= read -r invitation; do
            invitation_id="$(jq -r '.id' <<< "${invitation}")"
            full_name="$(jq -r '.repository.full_name // "unknown/unknown"' <<< "${invitation}")"

            status_code="$(curl -sS -o /tmp/accept_invite_response.json -w "%{http_code}" \
              -X PATCH \
              -H "${accept_header}" \
              -H "${auth_header}" \
              -H "${api_version_header}" \
              "${api_base}/user/repository_invitations/${invitation_id}")"

            if [[ "${status_code}" == "204" ]]; then
              accepted_invitations=$((accepted_invitations + 1))
              accepted_lines+=("✅ ${invitation_id} - ${full_name}")
              echo "Accepted invitation ${invitation_id} for ${full_name}"
            else
              failed_invitations=$((failed_invitations + 1))
              response_message="$(jq -r '.message // "Unknown error"' /tmp/accept_invite_response.json 2>/dev/null || echo "Unknown error")"
              failed_lines+=("❌ ${invitation_id} - ${full_name} (${response_message})")
              echo "Failed to accept invitation ${invitation_id} for ${full_name}: ${response_message}"
            fi
          done < <(jq -c '.[]' <<< "${matching_json}")

          {
            echo "total_invitations=${total_invitations}"
            echo "matching_invitations=${matching_invitations}"
            echo "accepted_invitations=${accepted_invitations}"
            echo "failed_invitations=${failed_invitations}"
          } >> "${GITHUB_OUTPUT}"

          {
            echo "### Invitation acceptance summary"
            echo
            echo "| Metric | Value |"
            echo "| --- | ---: |"
            echo "| Total invitations | ${total_invitations} |"
            echo "| Matching invitations | ${matching_invitations} |"
            echo "| Accepted invitations | ${accepted_invitations} |"
            echo "| Failed invitations | ${failed_invitations} |"
            echo

            if [[ ${#accepted_lines[@]} -gt 0 ]]; then
              echo "#### Accepted invitations"
              printf '%s\n' "${accepted_lines[@]}"
              echo
            fi

            if [[ ${#failed_lines[@]} -gt 0 ]]; then
              echo "#### Failed invitations"
              printf '%s\n' "${failed_lines[@]}"
              echo
            fi
          } >> "${GITHUB_STEP_SUMMARY}"

          echo "Aggregate results: Total=${total_invitations}, Matches=${matching_invitations}, Accepted=${accepted_invitations}, Failed=${failed_invitations}"

      - name: Echo outputs
        run: |
          echo "total_invitations=${{ steps.accept_invites.outputs.total_invitations }}"
          echo "matching_invitations=${{ steps.accept_invites.outputs.matching_invitations }}"
          echo "accepted_invitations=${{ steps.accept_invites.outputs.accepted_invitations }}"
          echo "failed_invitations=${{ steps.accept_invites.outputs.failed_invitations }}"
